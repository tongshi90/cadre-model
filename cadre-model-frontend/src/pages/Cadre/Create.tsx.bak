import { useState, useEffect } from 'react';
import { Form, Input, Select, DatePicker, Button, Card, message, TreeSelect } from 'antd';
import { useNavigate } from 'react-router-dom';
import { cadreApi } from '@/services/api';
import { departmentApi } from '@/services/departmentApi';
import { GENDER_OPTIONS, EDUCATION_OPTIONS, POLITICAL_STATUS_OPTIONS, CADRE_STATUS_OPTIONS } from '@/utils/constants';
import './Form.css';

const CadreCreate = () => {
  const navigate = useNavigate();
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [departmentTree, setDepartmentTree] = useState<any[]>([]);

  // 获取部门树
  useEffect(() => {
    const fetchDepartmentTree = async () => {
      try {
        const response = await departmentApi.getTree();
        const treeData = formatTreeData(response.data.data || []);
        setDepartmentTree(treeData);
      } catch (error) {
        console.error('Failed to fetch department tree:', error);
      }
    };
    fetchDepartmentTree();
  }, []);

  // 格式化树形数据为TreeSelect所需格式
  const formatTreeData = (data: any[]): any[] => {
    return data.map(item => ({
      title: item.name,
      value: item.id,
      key: item.id,
      children: item.children ? formatTreeData(item.children) : undefined,
    }));
  };

  const onFinish = async (values: any) => {
    setLoading(true);
    try {
      const data = {
        ...values,
        birth_date: values.birth_date?.format('YYYY-MM-DD'),
        entry_date: values.entry_date?.format('YYYY-MM-DD'),
      };
      await cadreApi.create(data);
      message.success('创建成功');
      navigate('/cadre');
    } catch (error) {
      console.error('Failed to create cadre:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="cadre-form-page">
      <Card className="form-card">
        <Form
          form={form}
          layout="vertical"
          onFinish={onFinish}
        >
          <Form.Item
            label="工号"
            name="employee_no"
            rules={[{ required: true, message: '请输入工号' }]}
          >
            <Input placeholder="请输入工号" />
          </Form.Item>

          <Form.Item
            label="姓名"
            name="name"
            rules={[{ required: true, message: '请输入姓名' }]}
          >
            <Input placeholder="请输入姓名" />
          </Form.Item>

          <Form.Item label="性别" name="gender">
            <Select placeholder="请选择性别" options={GENDER_OPTIONS} />
          </Form.Item>

          <Form.Item label="出生日期" name="birth_date">
            <DatePicker style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item label="入职日期" name="entry_date">
            <DatePicker style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item label="学历" name="education">
            <Select placeholder="请选择学历" options={EDUCATION_OPTIONS} />
          </Form.Item>

          <Form.Item label="专业" name="major">
            <Input placeholder="请输入专业" />
          </Form.Item>

          <Form.Item label="政治面貌" name="political_status">
            <Select placeholder="请选择政治面貌" options={POLITICAL_STATUS_OPTIONS} />
          </Form.Item>

          <Form.Item label="部门" name="department_id">
            <TreeSelect
              placeholder="请选择部门"
              treeData={departmentTree}
              allowClear
              showSearch
              treeDefaultExpandAll
              style={{ width: '100%' }}
            />
          </Form.Item>

          <Form.Item label="籍贯" name="native_place">
            <Input placeholder="请输入籍贯" />
          </Form.Item>

          <Form.Item label="资格证书" name="qualifications">
            <Input.TextArea rows={3} placeholder="请输入资格证书" />
          </Form.Item>

          <Form.Item label="备注" name="remark">
            <Input.TextArea rows={3} placeholder="请输入备注" />
          </Form.Item>

          <Form.Item>
            <Button type="primary" htmlType="submit" loading={loading}>
              提交
            </Button>
            <Button onClick={() => navigate(-1)}>
              取消
            </Button>
          </Form.Item>
        </Form>
      </Card>
    </div>
  );
};

export default CadreCreate;
